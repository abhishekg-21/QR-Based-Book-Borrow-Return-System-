<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Borrow Book</title>
    <link rel="stylesheet" href="borrow.css" />
  </head>
  <body>
    <div class="container">
      <h1>Borrow Books</h1>

      <!-- üìå Reader Login Form -->
      <div id="login-section" class="card">
        <h2>Enter Reader Details</h2>
        <input type="text" id="reader-id" placeholder="Enter Reader ID" />
        <input type="text" id="reader-name" placeholder="Enter Full Name" />
        <button onclick="validateReader()">Login</button>
        <p id="error-message" class="error"></p>
      </div>

      <!-- üìå Book Selection Section (Hidden Initially) -->
      <div id="book-section" class="card hidden">
        <h2>Select Books to Borrow</h2>
        <input
          type="text"
          id="search-book"
          placeholder="Search by Book ID or Name"
          onkeyup="searchBooks()"
        />
        <div id="book-list"></div>
        <button onclick="submitBorrow()">Submit Request</button>
        <p id="borrow-error" class="error"></p>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        fetchAvailableBooks();
      });

      let selectedBooks = [];
      let readerID = "";
      let requestCount = 0; // ‚úÖ Store request count

      // ‚úÖ Validate Reader
      async function validateReader() {
        const id = document.getElementById("reader-id").value.trim();
        const name = document.getElementById("reader-name").value.trim();
        const errorMessage = document.getElementById("error-message");

        if (!id || !name) {
          errorMessage.textContent = "‚ö†Ô∏è Reader ID and Name are required!";
          return;
        }

        try {
          const response = await fetch(
            `/validate-reader?reader_id=${id}&full_name=${name}`
          );
          const data = await response.json();

          if (data.valid) {
            alert("‚úÖ Login Successful!");
            readerID = id;
            requestCount = data.requested; // ‚úÖ Store number of requested books
            document.getElementById("login-section").classList.add("hidden");
            document.getElementById("book-section").classList.remove("hidden");
            errorMessage.textContent = "";
          } else {
            errorMessage.textContent = "‚ùå Invalid Reader ID or Name!";
          }
        } catch (error) {
          console.error(error);
          errorMessage.textContent = "‚ùå Server error. Try again!";
        }
      }

      // ‚úÖ Fetch Available Books
      async function fetchAvailableBooks() {
        try {
          const response = await fetch("/available-books");
          const books = await response.json();
          renderBookList(books);
        } catch (error) {
          console.error(error);
        }
      }

      // ‚úÖ Render Books in List
      function renderBookList(books) {
        const bookList = document.getElementById("book-list");
        bookList.innerHTML = "";

        books.forEach((book) => {
          const bookItem = document.createElement("div");
          bookItem.classList.add("book-item");

          bookItem.innerHTML = `
            <span>${book.book_id} - ${book.book_name}</span>
            <button id="book-${book.book_id}" onclick="selectBook(${book.book_id})">Select</button>
        `;

          bookList.appendChild(bookItem);
        });
      }

      // ‚úÖ Search Books
      function searchBooks() {
        const searchValue = document
          .getElementById("search-book")
          .value.toLowerCase();
        const bookItems = document.querySelectorAll(".book-item");

        bookItems.forEach((item) => {
          const text = item.textContent.toLowerCase();
          item.style.display = text.includes(searchValue) ? "flex" : "none";
        });
      }

      // ‚úÖ Select Book
      function selectBook(bookID) {
        if (selectedBooks.length >= 2) {
          alert("‚ö†Ô∏è You can only request 2 books at a time!");
          return;
        }

        const bookButton = document.getElementById(`book-${bookID}`);

        if (!selectedBooks.includes(bookID)) {
          selectedBooks.push(bookID);
          bookButton.style.backgroundColor = "red"; // ‚úÖ Change color to red
          bookButton.textContent = "Selected";
        }
      }

      // ‚úÖ Submit Borrow Request
      async function submitBorrow() {
        if (selectedBooks.length === 0) {
          alert("‚ö†Ô∏è Select at least one book!");
          return;
        }

        // ‚úÖ Use stored request count instead of extra API call
        if (requestCount + selectedBooks.length > 2) {
          alert(
            "‚ö†Ô∏è You have already made 2 requests! Returning to Welcome Page."
          );
          window.location.href = "welcome.html";
          return;
        }

        try {
          const response = await fetch("/submit-borrow", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ reader_id: readerID, books: selectedBooks }),
          });

          const data = await response.json();
          if (data.success) {
            alert("‚úÖ Borrow request submitted!");
            selectedBooks = [];
            window.location.href = "welcome.html"; // ‚úÖ Redirect after successful request
          } else {
            alert(data.message);
          }
        } catch (error) {
          console.error("üö® Fetch Error:", error);
          alert("‚ùå Error submitting request!");
        }
      }
    </script>
  </body>
</html>
